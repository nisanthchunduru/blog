version: "3"

tasks:
  create-aws-resources:
    desc: "Create an S3 bucket and a Dynamo table via AWS CLI (unless they already exist)"
    dotenv: ['taskfiles/../.env']
    cmds:
      - bash -c 'aws s3api head-bucket --bucket blog-terraform-state-607420117092 2>/dev/null ||
          aws s3api create-bucket --bucket blog-terraform-state-607420117092 --region us-east-1'
      - aws s3api put-bucket-versioning --bucket blog-terraform-state-607420117092
          --versioning-configuration Status=Enabled
      - aws s3api put-bucket-encryption --bucket blog-terraform-state-607420117092
          --server-side-encryption-configuration
          '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
      - aws s3api put-public-access-block --bucket blog-terraform-state-607420117092
          --public-access-block-configuration
          'BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true'
      - bash -c 'aws dynamodb describe-table --table-name blog-terraform-state-lock --region us-east-1 2>/dev/null ||
          aws dynamodb create-table --table-name blog-terraform-state-lock
          --attribute-definitions AttributeName=LockID,AttributeType=S
          --key-schema AttributeName=LockID,KeyType=HASH
          --billing-mode PAY_PER_REQUEST
          --region us-east-1'
      - aws dynamodb wait table-exists --table-name blog-terraform-state-lock --region us-east-1

  migrate:
    dir: infra
    cmds:
      - echo "yes" | terraform init -migrate-state

  run:
    cmds:
      - task: create-aws-resources
      - task: migrate
